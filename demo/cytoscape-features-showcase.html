<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cytoscape.js Features Showcase</title>
    
    <!-- Cytoscape.js and Extensions -->
    <script src="https://unpkg.com/cytoscape@3.31.0/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/cytoscape-fcose@2.2.0/cytoscape-fcose.js"></script>
    <script src="https://unpkg.com/cytoscape-expand-collapse@4.1.0/cytoscape-expand-collapse.js"></script>
    <script src="https://unpkg.com/cytoscape-popper@2.0.0/cytoscape-popper.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@6.3.7/dist/tippy-bundle.umd.min.js"></script>
    <script src="https://unpkg.com/cytoscape-context-menus@4.1.0/cytoscape-context-menus.js"></script>
    <script src="https://unpkg.com/cytoscape-cola@2.4.3/cytoscape-cola.js"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6.3.7/dist/tippy.css">
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: #fff;
            border-bottom: 1px solid #e9ecef;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 18px;
            color: #2c3e50;
            margin: 0;
        }
        
        .header .subtitle {
            color: #6c757d;
            font-size: 13px;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        .control-panel {
            width: 300px;
            background: #fff;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
            padding: 16px;
        }
        
        .graph-container {
            flex: 1;
            position: relative;
        }
        
        #cy {
            width: 100%;
            height: 100%;
            background: #fcfcfc;
        }
        
        .panel-section {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .panel-section:last-child {
            border-bottom: none;
        }
        
        .panel-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-group {
            margin-bottom: 12px;
        }
        
        .control-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 4px;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin: 2px;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn.btn-secondary {
            background: #6c757d;
        }
        
        .btn.btn-secondary:hover {
            background: #545b62;
        }
        
        .btn.btn-success {
            background: #28a745;
        }
        
        .btn.btn-success:hover {
            background: #1e7e34;
        }
        
        .btn.btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn.btn-warning:hover {
            background: #e0a800;
        }
        
        .btn.btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin: 0;
        }
        
        .checkbox-group label {
            margin: 0;
            font-size: 12px;
        }
        
        .slider-group {
            margin-bottom: 12px;
        }
        
        .slider-group input[type="range"] {
            width: 100%;
            margin: 4px 0;
        }
        
        .slider-value {
            font-size: 11px;
            color: #6c757d;
            text-align: right;
        }
        
        .layout-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 1000;
        }
        
        .error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            color: white;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: monospace;
        }
        
        .error-content {
            background: #dc3545;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            text-align: left;
        }
        
        .error-content h2 {
            margin: 0 0 15px 0;
            color: white;
        }
        
        .error-content ul {
            margin: 15px 0;
            padding-left: 20px;
        }
        
        .error-content code {
            background: rgba(0,0,0,0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .feature-badge {
            display: inline-block;
            background: #17a2b8;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 4px;
        }
        
        /* Custom context menu styling */
        .custom-context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            min-width: 150px;
        }
        
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .context-menu-item:hover {
            background: #f8f9fa;
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        /* Node tooltip styling */
        .node-tooltip {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            font-size: 12px;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .node-tooltip h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .node-tooltip .metadata {
            margin-bottom: 8px;
        }
        
        .node-tooltip .metadata div {
            margin-bottom: 2px;
            color: #6c757d;
        }
        
        .node-tooltip .connections {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }
        
        .node-tooltip .connections h4 {
            margin: 0 0 4px 0;
            font-size: 12px;
            color: #495057;
        }
        
        .tooltip-actions {
            margin-top: 8px;
            display: flex;
            gap: 4px;
        }
        
        .tooltip-actions button {
            padding: 4px 8px;
            font-size: 11px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .tooltip-actions button:hover {
            background: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Cytoscape.js Features Showcase</h1>
        <div class="subtitle">
            Demonstrating: Node Grouping ‚Ä¢ Filtering ‚Ä¢ Mixed Layouts ‚Ä¢ Interactivity ‚Ä¢ GUI Controls
        </div>
    </div>
    
    <div class="main-container">
        <div class="control-panel">
            <!-- Node Grouping Controls -->
            <div class="panel-section">
                <h3>üîó Node Grouping <span class="feature-badge">#1</span></h3>
                <div class="control-group">
                    <button class="btn btn-success" onclick="expandAll()">Expand All</button>
                    <button class="btn btn-warning" onclick="collapseAll()">Collapse All</button>
                </div>
                <div class="control-group">
                    <label>Individual Files:</label>
                    <div class="filter-buttons" id="file-buttons">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
            
            <!-- Filtering Controls -->
            <div class="panel-section">
                <h3>üîç Filtering <span class="feature-badge">#2</span></h3>
                <div class="control-group">
                    <label>Filter by Type:</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="show-functions" checked>
                        <label for="show-functions">Functions</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="show-classes" checked>
                        <label for="show-classes">Classes</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="show-variables" checked>
                        <label for="show-variables">Variables</label>
                    </div>
                </div>
                <div class="control-group">
                    <label>Visibility Mode:</label>
                    <button class="btn btn-small" onclick="setFilterMode('hide')">Hide</button>
                    <button class="btn btn-small" onclick="setFilterMode('fade')">Fade</button>
                    <button class="btn btn-small" onclick="setFilterMode('disable')">Disable</button>
                </div>
                <div class="control-group">
                    <button class="btn btn-secondary" onclick="resetFilters()">Reset All Filters</button>
                </div>
            </div>
            
            <!-- Layout Controls -->
            <div class="panel-section">
                <h3>üìê Mixed Layouts <span class="feature-badge">#3</span></h3>
                <div class="control-group">
                    <label>Layout Algorithm:</label>
                    <div class="layout-buttons">
                        <button class="btn btn-small" onclick="runLayout('fcose')">fCoSE</button>
                        <button class="btn btn-small" onclick="runLayout('cola')">Cola</button>
                        <button class="btn btn-small" onclick="runLayout('circle')">Circle</button>
                        <button class="btn btn-small" onclick="runLayout('grid')">Grid</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Fixed Positioning:</label>
                    <button class="btn btn-small" onclick="lockSelectedNodes()">Lock Selected</button>
                    <button class="btn btn-small" onclick="unlockAllNodes()">Unlock All</button>
                </div>
                <div class="control-group">
                    <div class="slider-group">
                        <label>Edge Length:</label>
                        <input type="range" id="edge-length" min="50" max="300" value="150">
                        <div class="slider-value" id="edge-length-value">150</div>
                    </div>
                </div>
            </div>
            
            <!-- Interactivity Controls -->
            <div class="panel-section">
                <h3>üéØ Interactivity <span class="feature-badge">#4</span></h3>
                <div class="control-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="enable-tooltips" checked>
                        <label for="enable-tooltips">Rich Tooltips</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="enable-context-menu" checked>
                        <label for="enable-context-menu">Context Menus</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="enable-focus-mode">
                        <label for="enable-focus-mode">Focus Mode</label>
                    </div>
                </div>
                <div class="control-group">
                    <label>Interaction Mode:</label>
                    <button class="btn btn-small" onclick="setInteractionMode('default')">Default</button>
                    <button class="btn btn-small" onclick="setInteractionMode('select')">Multi-Select</button>
                </div>
            </div>
            
            <!-- GUI Controls -->
            <div class="panel-section">
                <h3>üéõÔ∏è GUI Controls <span class="feature-badge">#5</span></h3>
                <div class="control-group">
                    <div class="slider-group">
                        <label>Zoom Level:</label>
                        <input type="range" id="zoom-control" min="0.1" max="3" step="0.1" value="1">
                        <div class="slider-value" id="zoom-value">1.0</div>
                    </div>
                </div>
                <div class="control-group">
                    <label>Graph Actions:</label>
                    <button class="btn btn-small" onclick="fitGraph()">Fit to Screen</button>
                    <button class="btn btn-small" onclick="centerGraph()">Center Graph</button>
                </div>
                <div class="control-group">
                    <label>Selection Info:</label>
                    <div id="selection-info" style="font-size: 11px; color: #6c757d; margin-top: 4px;">
                        No nodes selected
                    </div>
                </div>
            </div>
        </div>
        
        <div class="graph-container">
            <div id="cy"></div>
            <div class="status-indicator" id="status">
                Ready ‚Ä¢ Click nodes to explore ‚Ä¢ Right-click for actions
            </div>
        </div>
    </div>

    <script>
        // Check for required dependencies and show fatal error if missing
        function checkDependencies() {
            const missing = [];
            const extensions = {
                'cytoscape': { var: 'cytoscape', name: 'Cytoscape.js core', required: true },
                'cytoscapeFcose': { var: 'cytoscapeFcose', name: 'cytoscape-fcose', required: true },
                'cytoscapeExpandCollapse': { var: 'cytoscapeExpandCollapse', name: 'cytoscape-expand-collapse', required: true },
                'cytoscapePopper': { var: 'cytoscapePopper', name: 'cytoscape-popper', required: true },
                'cytoscapeContextMenus': { var: 'cytoscapeContextMenus', name: 'cytoscape-context-menus', required: true },
                'cytoscapeCola': { var: 'cytoscapeCola', name: 'cytoscape-cola', required: true },
                'tippy': { var: 'tippy', name: 'tippy.js', required: true }
            };
            
            for (const [key, ext] of Object.entries(extensions)) {
                if (ext.required && typeof window[ext.var] === 'undefined') {
                    missing.push(ext.name);
                }
            }
            
            if (missing.length > 0) {
                showFatalError(missing);
                return false;
            }
            
            return true;
        }
        
        function showFatalError(missing) {
            const errorHtml = `
                <div class="error-overlay">
                    <div class="error-content">
                        <h2>üö® Missing Dependencies</h2>
                        <p>The following required JavaScript libraries failed to load:</p>
                        <ul>
                            ${missing.map(lib => `<li><code>${lib}</code></li>`).join('')}
                        </ul>
                        <p><strong>Debug Info:</strong></p>
                        <ul>
                            <li>Check browser developer console for network errors</li>
                            <li>Verify CDN links are accessible</li>
                            <li>Check for ad blockers or network restrictions</li>
                        </ul>
                        <p><strong>Current loaded status:</strong></p>
                        <ul>
                            <li>cytoscape: <code>${typeof cytoscape}</code></li>
                            <li>cytoscapeFcose: <code>${typeof cytoscapeFcose}</code></li>
                            <li>cytoscapeExpandCollapse: <code>${typeof cytoscapeExpandCollapse}</code></li>
                            <li>cytoscapePopper: <code>${typeof cytoscapePopper}</code></li>
                            <li>cytoscapeContextMenus: <code>${typeof cytoscapeContextMenus}</code></li>
                            <li>cytoscapeCola: <code>${typeof cytoscapeCola}</code></li>
                            <li>tippy: <code>${typeof tippy}</code></li>
                        </ul>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('afterbegin', errorHtml);
        }
        
        // Initialize extensions only if all dependencies are present
        if (!checkDependencies()) {
            throw new Error('Required dependencies missing - see error overlay');
        }
        
        // Register extensions
        cytoscape.use(cytoscapeFcose);
        cytoscape.use(cytoscapeExpandCollapse);
        cytoscape.use(cytoscapePopper);
        cytoscape.use(cytoscapeContextMenus);
        cytoscape.use(cytoscapeCola);
        
        // Sample code structure data
        const sampleData = {
            nodes: [
                // Authentication Module (parent)
                { data: { id: 'auth-module', label: 'Authentication Module', type: 'module' } },
                
                // auth.js file (child of module)
                { data: { id: 'auth.js', label: 'auth.js', type: 'file', parent: 'auth-module' } },
                
                // Functions in auth.js
                { data: { id: 'login', label: 'login()', type: 'function', parent: 'auth.js', 
                         signature: 'login(username, password)', complexity: 'Medium',
                         description: 'Authenticates user credentials and creates session' } },
                { data: { id: 'logout', label: 'logout()', type: 'function', parent: 'auth.js',
                         signature: 'logout()', complexity: 'Low',
                         description: 'Destroys user session and clears tokens' } },
                { data: { id: 'validateToken', label: 'validateToken()', type: 'function', parent: 'auth.js',
                         signature: 'validateToken(token)', complexity: 'Medium',
                         description: 'Verifies JWT token validity and expiration' } },
                
                // session.js file (child of module)
                { data: { id: 'session.js', label: 'session.js', type: 'file', parent: 'auth-module' } },
                
                // Functions in session.js
                { data: { id: 'createSession', label: 'createSession()', type: 'function', parent: 'session.js',
                         signature: 'createSession(userId)', complexity: 'High',
                         description: 'Creates new user session with security tokens' } },
                { data: { id: 'destroySession', label: 'destroySession()', type: 'function', parent: 'session.js',
                         signature: 'destroySession(sessionId)', complexity: 'Medium',
                         description: 'Safely destroys session and cleans up resources' } },
                
                // Utils Module (parent)
                { data: { id: 'utils-module', label: 'Utilities Module', type: 'module' } },
                
                // utils.js file
                { data: { id: 'utils.js', label: 'utils.js', type: 'file', parent: 'utils-module' } },
                
                // Functions in utils.js
                { data: { id: 'parseJson', label: 'parseJson()', type: 'function', parent: 'utils.js',
                         signature: 'parseJson(jsonString)', complexity: 'Low',
                         description: 'Safely parses JSON with error handling' } },
                { data: { id: 'formatDate', label: 'formatDate()', type: 'function', parent: 'utils.js',
                         signature: 'formatDate(date, format)', complexity: 'Low',
                         description: 'Formats dates according to specified pattern' } },
                { data: { id: 'hashPassword', label: 'hashPassword()', type: 'function', parent: 'utils.js',
                         signature: 'hashPassword(password, salt)', complexity: 'High',
                         description: 'Securely hashes passwords using bcrypt' } },
                
                // Database Module (parent)  
                { data: { id: 'db-module', label: 'Database Module', type: 'module' } },
                
                // db.js file
                { data: { id: 'db.js', label: 'db.js', type: 'file', parent: 'db-module' } },
                
                // Database classes and functions
                { data: { id: 'UserModel', label: 'UserModel', type: 'class', parent: 'db.js',
                         description: 'User data model with CRUD operations' } },
                { data: { id: 'SessionModel', label: 'SessionModel', type: 'class', parent: 'db.js',
                         description: 'Session data model for authentication' } },
                { data: { id: 'connect', label: 'connect()', type: 'function', parent: 'db.js',
                         signature: 'connect(connectionString)', complexity: 'Medium',
                         description: 'Establishes database connection with retry logic' } },
                
                // Some standalone utilities
                { data: { id: 'config', label: 'config', type: 'variable',
                         description: 'Application configuration object' } },
                { data: { id: 'logger', label: 'logger', type: 'variable',
                         description: 'Centralized logging utility' } }
            ],
            
            edges: [
                // Authentication flow
                { data: { id: 'login-createSession', source: 'login', target: 'createSession', type: 'calls' } },
                { data: { id: 'login-hashPassword', source: 'login', target: 'hashPassword', type: 'calls' } },
                { data: { id: 'login-UserModel', source: 'login', target: 'UserModel', type: 'uses' } },
                
                // Session management
                { data: { id: 'logout-destroySession', source: 'logout', target: 'destroySession', type: 'calls' } },
                { data: { id: 'createSession-SessionModel', source: 'createSession', target: 'SessionModel', type: 'uses' } },
                { data: { id: 'destroySession-SessionModel', source: 'destroySession', target: 'SessionModel', type: 'uses' } },
                
                // Utility dependencies
                { data: { id: 'validateToken-parseJson', source: 'validateToken', target: 'parseJson', type: 'calls' } },
                { data: { id: 'createSession-formatDate', source: 'createSession', target: 'formatDate', type: 'calls' } },
                
                // Database connections
                { data: { id: 'UserModel-connect', source: 'UserModel', target: 'connect', type: 'uses' } },
                { data: { id: 'SessionModel-connect', source: 'SessionModel', target: 'connect', type: 'uses' } },
                
                // Configuration dependencies
                { data: { id: 'connect-config', source: 'connect', target: 'config', type: 'reads' } },
                { data: { id: 'login-logger', source: 'login', target: 'logger', type: 'uses' } },
                { data: { id: 'hashPassword-logger', source: 'hashPassword', target: 'logger', type: 'uses' } }
            ]
        };
        
        // Initialize Cytoscape instance
        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: [...sampleData.nodes, ...sampleData.edges],
            
            style: [
                // Base node styles
                {
                    selector: 'node',
                    style: {
                        'background-color': '#3498db',
                        'label': 'data(label)',
                        'font-size': '10px',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'color': '#2c3e50',
                        'text-wrap': 'wrap',
                        'text-max-width': '80px',
                        'overlay-padding': '4px'
                    }
                },
                
                // Parent nodes (modules and files)
                {
                    selector: 'node:parent',
                    style: {
                        'background-color': '#ecf0f1',
                        'background-opacity': 0.8,
                        'border-width': 2,
                        'border-color': '#bdc3c7',
                        'padding': 10,
                        'compound-sizing-wrt-labels': 'include',
                        'font-weight': 'bold'
                    }
                },
                
                // Module level
                {
                    selector: 'node[type = "module"]',
                    style: {
                        'background-color': '#e8f4fd',
                        'border-color': '#3498db',
                        'border-width': 3,
                        'font-size': '12px',
                        'color': '#2980b9'
                    }
                },
                
                // File level
                {
                    selector: 'node[type = "file"]',
                    style: {
                        'background-color': '#f8f9fa',
                        'border-color': '#6c757d',
                        'border-width': 2,
                        'font-size': '11px',
                        'color': '#495057'
                    }
                },
                
                // Function nodes
                {
                    selector: 'node[type = "function"]',
                    style: {
                        'background-color': '#2ecc71',
                        'shape': 'round-rectangle',
                        'width': '60px',
                        'height': '30px',
                        'font-size': '9px',
                        'color': 'white'
                    }
                },
                
                // Class nodes
                {
                    selector: 'node[type = "class"]',
                    style: {
                        'background-color': '#e74c3c',
                        'shape': 'round-rectangle',
                        'width': '60px',
                        'height': '30px',
                        'font-size': '9px',
                        'color': 'white'
                    }
                },
                
                // Variable nodes
                {
                    selector: 'node[type = "variable"]',
                    style: {
                        'background-color': '#f39c12',
                        'shape': 'ellipse',
                        'width': '50px',
                        'height': '25px',
                        'font-size': '8px',
                        'color': 'white'
                    }
                },
                
                // Collapsed state
                {
                    selector: 'node.collapsed',
                    style: {
                        'background-color': '#f1c40f',
                        'border-width': 3,
                        'border-color': '#f39c12'
                    }
                },
                
                // Selected state
                {
                    selector: 'node.selected',
                    style: {
                        'border-width': 4,
                        'border-color': '#e91e63',
                        'background-color': '#fce4ec'
                    }
                },
                
                // Highlighted state
                {
                    selector: 'node.highlighted',
                    style: {
                        'border-width': 3,
                        'border-color': '#ff5722',
                        'background-color': '#ffccbc'
                    }
                },
                
                // Edge styles
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#95a5a6',
                        'target-arrow-shape': 'triangle',
                        'target-arrow-color': '#95a5a6',
                        'curve-style': 'bezier',
                        'edge-distances': 'intersection'
                    }
                },
                
                // Different edge types
                {
                    selector: 'edge[type = "calls"]',
                    style: {
                        'line-color': '#3498db',
                        'target-arrow-color': '#3498db',
                        'width': 2
                    }
                },
                
                {
                    selector: 'edge[type = "uses"]',
                    style: {
                        'line-color': '#e74c3c',
                        'target-arrow-color': '#e74c3c',
                        'line-style': 'dashed',
                        'width': 1.5
                    }
                },
                
                {
                    selector: 'edge[type = "reads"]',
                    style: {
                        'line-color': '#f39c12',
                        'target-arrow-color': '#f39c12',
                        'line-style': 'dotted',
                        'width': 1
                    }
                }
            ],
            
            layout: {
                name: 'fcose',
                animate: true,
                fit: true,
                padding: 30,
                nodeDimensionsIncludeLabels: true,
                uniformNodeDimensions: false,
                packComponents: true,
                nestingFactor: 0.1,
                gravity: 0.25,
                numIter: 2500
            }
        });
        
        // Initialize expand-collapse extension
        const expandCollapseApi = cy.expandCollapse({
            layoutBy: {
                name: 'fcose',
                animate: true,
                fit: false,
                padding: 10
            },
            fisheye: true,
            animate: true,
            undoable: false,
            cueEnabled: true,
            expandCollapseCuePosition: 'top-left',
            expandCollapseCueSize: 12,
            expandCollapseCueLineSize: 8,
            expandCueImage: undefined,
            collapseCueImage: undefined,
            expandCollapseCueSensitivity: 1
        });
        
        // Initialize context menu
        const contextMenu = cy.contextMenus({
            menuItems: [
                {
                    id: 'expand-collapse',
                    content: function(ele) {
                        if (ele.isParent()) {
                            return expandCollapseApi.isCollapsible(ele) ? 'Collapse' : 'Expand';
                        }
                        return null;
                    },
                    selector: 'node:parent',
                    onClickFunction: function(event) {
                        const node = event.target;
                        if (expandCollapseApi.isCollapsible(node)) {
                            expandCollapseApi.collapse(node);
                        } else {
                            expandCollapseApi.expand(node);
                        }
                    }
                },
                {
                    id: 'focus',
                    content: 'Focus on This',
                    selector: 'node',
                    onClickFunction: function(event) {
                        focusOnNode(event.target);
                    }
                },
                {
                    id: 'lock-position',
                    content: 'Lock Position',
                    selector: 'node',
                    onClickFunction: function(event) {
                        const node = event.target;
                        node.lock();
                        updateStatus(`Locked ${node.data('label')}`);
                    }
                },
                {
                    id: 'separator',
                    content: '---'
                },
                {
                    id: 'hide',
                    content: 'Hide Node',
                    selector: 'node',
                    onClickFunction: function(event) {
                        const node = event.target;
                        node.style('display', 'none');
                        updateStatus(`Hidden ${node.data('label')}`);
                    }
                }
            ],
            menuRadius: 100,
            selector: 'node, edge',
            fillColor: 'rgba(0, 0, 0, 0.75)',
            activeFillColor: 'rgba(92, 194, 237, 0.75)',
            activePadding: 20,
            indicatorSize: 24,
            separatorWidth: 3,
            spotlightPadding: 4,
            minSpotlightRadius: 24,
            maxSpotlightRadius: 38
        });
        
        // State management
        let currentFilterMode = 'hide';
        let selectedNodes = cy.collection();
        let interactionMode = 'default';
        let tooltipsEnabled = true;
        let contextMenuEnabled = true;
        let focusMode = false;
        
        // Initialize tooltips for all nodes
        function initializeTooltips() {
            cy.nodes().forEach(node => {
                if (node.data('type') === 'module' || node.data('type') === 'file') return;
                
                const ref = node.popperRef();
                const tip = tippy(ref, {
                    content: () => createTooltipContent(node),
                    allowHTML: true,
                    placement: 'top',
                    hideOnClick: false,
                    sticky: true,
                    appendTo: document.body,
                    interactive: true
                });
                
                node.data('tooltip', tip);
            });
        }
        
        function createTooltipContent(node) {
            const data = node.data();
            const inDegree = node.indegree();
            const outDegree = node.outdegree();
            
            return `
                <div class="node-tooltip">
                    <h3>${data.label}</h3>
                    <div class="metadata">
                        <div><strong>Type:</strong> ${data.type}</div>
                        ${data.signature ? `<div><strong>Signature:</strong> ${data.signature}</div>` : ''}
                        ${data.complexity ? `<div><strong>Complexity:</strong> ${data.complexity}</div>` : ''}
                        ${data.description ? `<div><strong>Description:</strong> ${data.description}</div>` : ''}
                    </div>
                    <div class="connections">
                        <h4>Connections</h4>
                        <div>Incoming: ${inDegree}</div>
                        <div>Outgoing: ${outDegree}</div>
                    </div>
                    <div class="tooltip-actions">
                        <button onclick="focusOnNode(cy.getElementById('${node.id()}'))">Focus</button>
                        <button onclick="selectNode(cy.getElementById('${node.id()}'))">Select</button>
                    </div>
                </div>
            `;
        }
        
        // Event handlers
        cy.on('tap', 'node', function(evt) {
            const node = evt.target;
            
            if (interactionMode === 'select') {
                toggleNodeSelection(node);
            } else if (focusMode) {
                focusOnNode(node);
            } else {
                // Default interaction
                highlightNode(node);
            }
        });
        
        cy.on('tap', function(evt) {
            if (evt.target === cy) {
                clearHighlights();
                clearSelections();
            }
        });
        
        cy.on('mouseover', 'node', function(evt) {
            if (!focusMode) {
                evt.target.addClass('highlighted');
            }
        });
        
        cy.on('mouseout', 'node', function(evt) {
            if (!focusMode) {
                evt.target.removeClass('highlighted');
            }
        });
        
        // Core functionality
        function focusOnNode(node) {
            const connectedNodes = node.neighborhood().nodes();
            const allConnected = connectedNodes.union(node);
            
            cy.nodes().style('opacity', 0.2);
            cy.edges().style('opacity', 0.1);
            
            allConnected.style('opacity', 1);
            node.connectedEdges().style('opacity', 0.8);
            
            updateStatus(`Focused on ${node.data('label')}`);
        }
        
        function highlightNode(node) {
            clearHighlights();
            node.addClass('highlighted');
            node.neighborhood().addClass('highlighted');
        }
        
        function clearHighlights() {
            cy.elements().removeClass('highlighted');
            cy.nodes().style('opacity', 1);
            cy.edges().style('opacity', 1);
        }
        
        function toggleNodeSelection(node) {
            if (selectedNodes.contains(node)) {
                selectedNodes = selectedNodes.difference(node);
                node.removeClass('selected');
            } else {
                selectedNodes = selectedNodes.union(node);
                node.addClass('selected');
            }
            updateSelectionInfo();
        }
        
        function selectNode(node) {
            if (!selectedNodes.contains(node)) {
                selectedNodes = selectedNodes.union(node);
                node.addClass('selected');
                updateSelectionInfo();
            }
        }
        
        function clearSelections() {
            selectedNodes.removeClass('selected');
            selectedNodes = cy.collection();
            updateSelectionInfo();
        }
        
        function updateSelectionInfo() {
            const count = selectedNodes.length;
            const info = document.getElementById('selection-info');
            if (count === 0) {
                info.textContent = 'No nodes selected';
            } else if (count === 1) {
                info.textContent = `1 node selected: ${selectedNodes[0].data('label')}`;
            } else {
                info.textContent = `${count} nodes selected`;
            }
        }
        
        function updateStatus(message) {
            const status = document.getElementById('status');
            status.textContent = message;
            setTimeout(() => {
                status.textContent = 'Ready ‚Ä¢ Click nodes to explore ‚Ä¢ Right-click for actions';
            }, 3000);
        }
        
        // Control panel functions
        function expandAll() {
            expandCollapseApi.expandAll();
            updateStatus('Expanded all groups');
        }
        
        function collapseAll() {
            expandCollapseApi.collapseAll();
            updateStatus('Collapsed all groups');
        }
        
        function applyTypeFilter() {
            const showFunctions = document.getElementById('show-functions').checked;
            const showClasses = document.getElementById('show-classes').checked;
            const showVariables = document.getElementById('show-variables').checked;
            
            cy.batch(() => {
                cy.nodes('[type = "function"]').forEach(node => {
                    setNodeVisibility(node, showFunctions);
                });
                
                cy.nodes('[type = "class"]').forEach(node => {
                    setNodeVisibility(node, showClasses);
                });
                
                cy.nodes('[type = "variable"]').forEach(node => {
                    setNodeVisibility(node, showVariables);
                });
            });
        }
        
        function setNodeVisibility(node, visible) {
            if (currentFilterMode === 'hide') {
                node.style('display', visible ? 'element' : 'none');
            } else if (currentFilterMode === 'fade') {
                node.style('opacity', visible ? 1 : 0.2);
            } else if (currentFilterMode === 'disable') {
                node.style('events', visible ? 'yes' : 'no');
                node.style('opacity', visible ? 1 : 0.5);
            }
        }
        
        function setFilterMode(mode) {
            currentFilterMode = mode;
            updateStatus(`Filter mode: ${mode}`);
            applyTypeFilter();
        }
        
        function resetFilters() {
            document.getElementById('show-functions').checked = true;
            document.getElementById('show-classes').checked = true;
            document.getElementById('show-variables').checked = true;
            
            cy.nodes().style({
                'display': 'element',
                'opacity': 1,
                'events': 'yes'
            });
            
            clearHighlights();
            updateStatus('Filters reset');
        }
        
        function runLayout(layoutName) {
            const edgeLength = parseInt(document.getElementById('edge-length').value);
            
            const layoutOptions = {
                'fcose': {
                    name: 'fcose',
                    animate: true,
                    fit: true,
                    padding: 30,
                    idealEdgeLength: edgeLength,
                    nestingFactor: 0.1,
                    gravity: 0.25,
                    numIter: 2000
                },
                'cola': {
                    name: 'cola',
                    animate: true,
                    fit: true,
                    edgeLength: edgeLength,
                    nodeSpacing: 10,
                    flow: { axis: 'y', minSeparation: 30 }
                },
                'circle': {
                    name: 'circle',
                    animate: true,
                    fit: true,
                    radius: edgeLength * 2
                },
                'grid': {
                    name: 'grid',
                    animate: true,
                    fit: true,
                    rows: Math.ceil(Math.sqrt(cy.nodes().length)),
                    cols: Math.ceil(Math.sqrt(cy.nodes().length))
                }
            };
            
            cy.layout(layoutOptions[layoutName]).run();
            updateStatus(`Applied ${layoutName} layout`);
        }
        
        function lockSelectedNodes() {
            if (selectedNodes.length === 0) {
                updateStatus('No nodes selected to lock');
                return;
            }
            
            selectedNodes.lock();
            updateStatus(`Locked ${selectedNodes.length} nodes`);
        }
        
        function unlockAllNodes() {
            cy.nodes().unlock();
            updateStatus('Unlocked all nodes');
        }
        
        function setInteractionMode(mode) {
            interactionMode = mode;
            if (mode === 'select') {
                updateStatus('Multi-select mode: Ctrl+click to select multiple nodes');
            } else {
                updateStatus('Default interaction mode');
                clearSelections();
            }
        }
        
        function fitGraph() {
            cy.fit();
            updateStatus('Fitted graph to screen');
        }
        
        function centerGraph() {
            cy.center();
            updateStatus('Centered graph');
        }
        
        // Initialize control panel event handlers
        document.getElementById('show-functions').addEventListener('change', applyTypeFilter);
        document.getElementById('show-classes').addEventListener('change', applyTypeFilter);
        document.getElementById('show-variables').addEventListener('change', applyTypeFilter);
        
        document.getElementById('enable-tooltips').addEventListener('change', function() {
            tooltipsEnabled = this.checked;
            cy.nodes().forEach(node => {
                const tooltip = node.data('tooltip');
                if (tooltip) {
                    if (tooltipsEnabled) {
                        tooltip.enable();
                    } else {
                        tooltip.disable();
                    }
                }
            });
        });
        
        document.getElementById('enable-context-menu').addEventListener('change', function() {
            contextMenuEnabled = this.checked;
            // Context menu enable/disable would need custom implementation
        });
        
        document.getElementById('enable-focus-mode').addEventListener('change', function() {
            focusMode = this.checked;
            if (!focusMode) {
                clearHighlights();
            }
        });
        
        document.getElementById('edge-length').addEventListener('input', function() {
            document.getElementById('edge-length-value').textContent = this.value;
        });
        
        document.getElementById('zoom-control').addEventListener('input', function() {
            const zoomLevel = parseFloat(this.value);
            cy.zoom(zoomLevel);
            document.getElementById('zoom-value').textContent = zoomLevel.toFixed(1);
        });
        
        // Update zoom control when zoom changes
        cy.on('zoom', function() {
            const currentZoom = cy.zoom();
            document.getElementById('zoom-control').value = currentZoom;
            document.getElementById('zoom-value').textContent = currentZoom.toFixed(1);
        });
        
        // Generate file control buttons
        function initializeFileButtons() {
            const fileButtons = document.getElementById('file-buttons');
            const files = cy.nodes('[type = "file"]');
            
            files.forEach(file => {
                const button = document.createElement('button');
                button.className = 'btn btn-small';
                button.textContent = file.data('label');
                button.onclick = () => {
                    if (expandCollapseApi.isCollapsible(file)) {
                        expandCollapseApi.collapse(file);
                        updateStatus(`Collapsed ${file.data('label')}`);
                    } else {
                        expandCollapseApi.expand(file);
                        updateStatus(`Expanded ${file.data('label')}`);
                    }
                };
                fileButtons.appendChild(button);
            });
        }
        
        // Initialize everything
        initializeTooltips();
        initializeFileButtons();
        updateStatus('Demo ready! Explore all 5 priority features using the controls');
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(evt) {
            if (evt.target.tagName === 'INPUT') return;
            
            switch (evt.key) {
                case 'Escape':
                    clearHighlights();
                    clearSelections();
                    updateStatus('Cleared selections and highlights');
                    break;
                case 'f':
                    if (evt.ctrlKey) {
                        evt.preventDefault();
                        fitGraph();
                    }
                    break;
                case 'c':
                    if (evt.ctrlKey) {
                        evt.preventDefault();
                        centerGraph();
                    }
                    break;
                case 'r':
                    if (evt.ctrlKey) {
                        evt.preventDefault();
                        resetFilters();
                    }
                    break;
            }
        });
        
    </script>
</body>
</html>